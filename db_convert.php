<?php

ini_set('max_execution_time', 0);
ini_set('memory_limit', '1024M');
ini_set('mssql.charset', 'UTF-8');

$db = mssql_connect ('127.0.0.1', 'sa', '');
mssql_select_db ('lin2world', $db) or die (mssql_error());

$q = mssql_query("
select char_id, item_id, item_type, warehouse
from user_item 
where item_type in (1047, 1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059, 1095, 1096, 1097, 1098, 1099, 1150, 1151, 1152, 1294, 1370, 1371, 1372, 1377, 1378, 1379, 1380, 1381, 1382, 1383, 1384, 1385, 1386, 1387, 1388, 1389, 1390, 1391, 1392, 1393, 1394, 1395, 1396, 1397, 1398, 1399, 1400, 1401, 1402, 1403, 1404, 1405, 1406, 1407, 1408, 1409, 1410, 1411, 1412, 1413, 1414, 1415, 1416, 1417, 1418, 1512, 1513, 1514, 1515, 1516, 1517, 1518, 1519, 1520, 1521, 1522, 1523, 1524, 1525, 1526, 1527, 1528, 1529, 1530, 1531, 1532, 1533, 1534, 1535, 1536, 1537, 1667, 1668, 1669, 1670, 1671, 1856, 3038, 3039, 3040, 3041, 3042, 3043, 3044, 3045, 3046, 3047, 3048, 3049, 3050, 3051, 3052, 3053, 3054, 3055, 3056, 3057, 3058, 3059, 3060, 3061, 3062, 3063, 3064, 3065, 3066, 3067, 3068, 3069, 3070, 3071, 3072, 3073, 3074, 3075, 3076, 3077, 3078, 3079, 3080, 3081, 3082, 3083, 3084, 3085, 3086, 3087, 3088, 3089, 3090, 3091, 3092, 3093, 3094, 3095, 3096, 3097, 3098, 3099, 3100, 3101, 3102, 3103, 3104, 3105, 3106, 3107, 3108, 3109, 3110, 3111, 3112, 3113, 3114, 3115, 3116, 3117, 3118, 3429, 3430, 3431, 3432, 3940, 3941, 3942, 3943, 3944, 4200, 4201, 4203, 4204, 4205, 4206, 4207, 4208, 4906, 4907, 4908, 4909, 4910, 4911, 4912, 4913, 4914, 4915, 4916, 4917, 4918, 4919, 4920, 4921, 4922, 4923, 4924, 4925, 4926, 4927, 4928, 4929, 4930, 4931, 4932, 4933, 4934, 4935, 5013, 5014, 5015, 5809, 5810, 5811, 5812, 5813, 5814, 5815, 5816, 6350, 6351, 6352, 6395, 6396, 6397, 6398, 7638, 7639, 7640, 7641, 7642, 7643, 7644, 7645, 7646, 7647, 7648, 7649, 7650, 7651, 7652, 7653, 7654, 7655, 7656, 7657, 7658, 7659, 7660, 7661, 7662, 7663, 7664, 7665, 7666, 7667, 7668, 7669, 7670, 7671, 7672, 7673, 7674, 7675, 7676, 7835, 8380, 8381, 8382, 8383, 8384, 8385, 8386, 8387, 8388, 8389, 8390, 8391, 8392, 8393, 8394, 8395, 8396, 8397, 8398, 8399, 8400, 8401, 8402, 8616, 8617, 8618, 8619, 8620, 8621, 8877, 8878, 8879, 8880, 8881, 8882, 8883, 8884, 8885, 8886, 8887, 8888, 8889, 8890, 8891, 8892, 8893, 8894, 8895, 8896, 8897, 8898, 8899, 8900, 8901, 8902, 8903, 8904, 8905, 8906, 8907, 8908, 8909, 8945, 8946)
order by char_id", $db);

$books = array();
if ($q && mssql_num_rows($q)>0) {
	while($row = mssql_fetch_assoc($q))
	{
		$books[ $row['char_id'] ][ $row['warehouse'] ][] = array( $row['item_type'], $row['item_id'] );
	}
}

foreach ( $books as $char_id => $wh )
{
	foreach ( $wh as $warehouse => $i )
	{
		$items = array();
		foreach ( $i as $item )	{
			$items[ $item[1] ] = $item[0];
		}

		foreach(array_count_values($items) as $type => $amount)
		{
			if($amount > 1)
			{
				echo ">> $char_id : wh=$warehouse : type=$type : count=$amount \r\n";

				$ids = array_keys( $items, $type );
				sort($ids, SORT_NUMERIC);
				$item_id = $ids[0];
				unset($ids[0]);

				$sql = "UPDATE user_item SET amount = {$amount} WHERE item_id = {$item_id}";
				echo "$sql => ";
				$q = mssql_query($sql, $db);
				if (mssql_rows_affected($db) == 1)
				{
					echo "OK \r\n";
					foreach ($ids as $id)
					{
						$sql = "DELETE FROM user_item WHERE item_id = $id";
						echo "$sql => ";
						$q = mssql_query($sql, $db);
						if (mssql_rows_affected($db) == 1)
						{
							echo "OK \r\n";
						}
					}
				}		
			}
		}
	}
}


?>